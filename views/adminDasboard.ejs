<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord Admin - Gestion des Livres</title>
  <link rel="stylesheet" href="/styles.css"> <!-- Si tu as un fichier CSS externe -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Gestion des Livres</h1>
    
    <!-- Bouton pour ouvrir le modal d'ajout -->
    <button id="openAddModal">Ajouter un livre</button>

    <!-- Table des livres -->
    <table id="booksTable">
      <thead>
        <tr>
          <th>Titre</th>
          <th>Stock</th>
          <th>Nombre de pages</th>
          <th>Genre</th>
          <th>Auteur</th>
          <th>Catégorie</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les livres seront ajoutés dynamiquement ici via AJAX -->
      </tbody>
    </table>

    <!-- Modal pour l'ajout et la modification des livres -->
    <div id="bookModal" style="display: none;">
      <div class="modal-content">
        <h2 id="modalTitle">Ajouter un Livre</h2>
        <form id="bookForm">
          <input type="hidden" id="bookId" name="bookId">
          <div>
            <label for="title">Titre</label>
            <input type="text" id="title" name="title" required>
          </div>
          <div>
            <label for="stock">Stock</label>
            <input type="number" id="stock" name="stock" required>
          </div>
          <div>
            <label for="page_count">Nombre de pages</label>
            <input type="number" id="page_count" name="page_count" required>
          </div>
          <div>
            <label for="genre">Genre</label>
            <input type="text" id="genre" name="genre" required>
          </div>
          <div>
            <label for="author">Auteur</label>
            <input type="text" id="author" name="author" required>
          </div>
          <div>
            <label for="category_id">Catégorie</label>
            <input type="number" id="category_id" name="category_id" required>
          </div>
          <button type="submit">Sauvegarder</button>
          <button type="button" id="closeModal">Fermer</button>
        </form>
      </div>
    </div>

  </div>

  <script>
    // Charger les livres au démarrage de la page
    $(document).ready(function() {
      loadBooks();

      // Ouvrir le modal pour ajouter un livre
      $('#openAddModal').click(function() {
        $('#bookForm')[0].reset();
        $('#bookId').val('');
        $('#modalTitle').text('Ajouter un Livre');
        $('#bookModal').show();
      });

      // Fermer le modal
      $('#closeModal').click(function() {
        $('#bookModal').hide();
      });

      // Soumettre le formulaire pour ajouter ou modifier un livre
      $('#bookForm').submit(function(e) {
        e.preventDefault();
        const bookData = {
          title: $('#title').val(),
          stock: $('#stock').val(),
          page_count: $('#page_count').val(),
          genre: $('#genre').val(),
          author: $('#author').val(),
          category_id: $('#category_id').val(),
        };
        const bookId = $('#bookId').val();
        if (bookId) {
          // Modifier le livre
          $.ajax({
            url: `/books/${bookId}`,
            method: 'PUT',
            data: bookData,
            success: function(response) {
              alert(response.message);
              loadBooks();
              $('#bookModal').hide();
            },
            error: function(err) {
              alert('Erreur lors de la mise à jour du livre');
            }
          });
        } else {
          // Ajouter un nouveau livre
          $.ajax({
            url: '/books',
            method: 'POST',
            data: bookData,
            success: function(response) {
              alert(response.message);
              loadBooks();
              $('#bookModal').hide();
            },
            error: function(err) {
              alert('Erreur lors de la création du livre');
            }
          });
        }
      });

      // Charger la liste des livres
      function loadBooks() {
        $.ajax({
          url: '/books',
          method: 'GET',
          success: function(data) {
            const tbody = $('#booksTable tbody');
            tbody.empty();
            data.forEach(function(book) {
              const row = `
                <tr>
                  <td>${book.title}</td>
                  <td>${book.stock}</td>
                  <td>${book.page_count}</td>
                  <td>${book.genre}</td>
                  <td>${book.author}</td>
                  <td>${book.category_id}</td>
                  <td>
                    <button class="editBtn" data-id="${book.id}">Modifier</button>
                    <button class="deleteBtn" data-id="${book.id}">Supprimer</button>
                  </td>
                </tr>
              `;
              tbody.append(row);
            });

            // Gérer la modification d'un livre
            $('.editBtn').click(function() {
              const bookId = $(this).data('id');
              $.ajax({
                url: `/books/${bookId}`,
                method: 'GET',
                success: function(book) {
                  $('#bookId').val(book.id);
                  $('#title').val(book.title);
                  $('#stock').val(book.stock);
                  $('#page_count').val(book.page_count);
                  $('#genre').val(book.genre);
                  $('#author').val(book.author);
                  $('#category_id').val(book.category_id);
                  $('#modalTitle').text('Modifier un Livre');
                  $('#bookModal').show();
                }
              });
            });

            // Gérer la suppression d'un livre
            $('.deleteBtn').click(function() {
              const bookId = $(this).data('id');
              if (confirm('Êtes-vous sûr de vouloir supprimer ce livre ?')) {
                $.ajax({
                  url: `/books/${bookId}`,
                  method: 'DELETE',
                  success: function(response) {
                    alert(response.message);
                    loadBooks();
                  },
                  error: function(err) {
                    alert('Erreur lors de la suppression du livre');
                  }
                });
              }
            });
          }
        });
      }
    });
  </script>
</body>
</html>
